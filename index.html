<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>SincJS</title>
    <link rel="stylesheet" href="dist/css/grapes.min.css">
    <script
  src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
  integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
  crossorigin="anonymous"></script>
    <script src="dist/grapes.min.js"></script>
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
      }
    </style>
  </head>

  <body>
    <div id="gjs" style="height:0px; overflow:hidden;">
      <div class="panel">
        <h1 class="welcome">Welcome to</h1>
        <div class="big-title">
          <svg class="logo" viewBox="0 0 100 100">
            <path d="M40 5l-12.9 7.4 -12.9 7.4c-1.4 0.8-2.7 2.3-3.7 3.9 -0.9 1.6-1.5 3.5-1.5 5.1v14.9 14.9c0 1.7 0.6 3.5 1.5 5.1 0.9 1.6 2.2 3.1 3.7 3.9l12.9 7.4 12.9 7.4c1.4 0.8 3.3 1.2 5.2 1.2 1.9 0 3.8-0.4 5.2-1.2l12.9-7.4 12.9-7.4c1.4-0.8 2.7-2.2 3.7-3.9 0.9-1.6 1.5-3.5 1.5-5.1v-14.9 -12.7c0-4.6-3.8-6-6.8-4.2l-28 16.2"/>
          </svg>
          <span>SincJS</span>
        </div>
        <div class="description">
          This is a demo content from index.html. For the development, you shouldn't edit this file, instead you can
          copy and rename it to _index.html, on next server start the new file will be served, and it will be ignored by git.
        </div>
      </div>
      <style>
        .panel {
          width: 90%;
          max-width: 700px;
          border-radius: 3px;
          padding: 30px 20px;
          margin: 150px auto 0px;
          background-color: #d983a6;
          box-shadow: 0px 3px 10px 0px rgba(0,0,0,0.25);
          color:rgba(255,255,255,0.75);
          font: caption;
          font-weight: 100;
        }

        .welcome {
          text-align: center;
          font-weight: 100;
          margin: 0px;
        }

        .logo {
          width: 70px;
          height: 70px;
          vertical-align: middle;
        }

        .logo path {
          pointer-events: none;
          fill: none;
          stroke-linecap: round;
          stroke-width: 7;
          stroke: #fff
        }

        .big-title {
          text-align: center;
          font-size: 3.5rem;
          margin: 15px 0;
        }

        .description {
          text-align: justify;
          font-size: 1rem;
          line-height: 1.5rem;
        }

      </style>
    </div>
    <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet"/>
    <script src="https://unpkg.com/grapesjs"></script>
    <link href="node_modules/grapesjs-preset-webpage/dist/grapesjs-preset-webpage.min.css" rel="stylesheet"/>
    <script src="node_modules/grapesjs-preset-webpage/dist/grapesjs-preset-webpage.min.js"></script>
    <script src="node_modules/grapesjs-blocks-basic/dist/grapesjs-blocks-basic.min.js"></script>
    <script src="node_modules/grapesjs-custom-code/dist/grapesjs-custom-code.min.js"></script>
    <script src="node_modules/grapesjs-plugin-export/dist/grapesjs-plugin-export.min.js"></script>
    

    <script type="text/javascript">
      function myPlugin(editor, options){
          try{
            const c = options;
            const bm = editor.BlockManager;
            
            //Components
            const dc = editor.DomComponents;
            const defaultType = dc.getType('default');
            const defaultModel = defaultType.model;
            const defaultView = defaultType.view;
            const commands = editor.Commands;

            var datasourceModal = null;
            commands.add('datasource-modal', {
              run(editor) {
                const self = this;
                datasourceModal = editor.Modal.open({
                  title: 'Datasource',
                  content: `<div>LOL</div>`,
                });
                debugger;
                datasourceModal.onceClose(() => {
                  editor.stopCommand('datasource-modal');
                });
                console.log('started');
              },
              stop(editor) {
                console.log('stopped');
              },
            });
            
            var pnm = editor.Panels;
            pnm.addButton("options", [{
              id: "print",
              className: "fa fa-print icon-print",
              command: function command(editor, sender) {
                sender.set("active", 0);
                //TODO
                editor.runCommand('datasource-modal');
              },
              attributes: {
                title: "Print"
              }
            }, {
              id: "datasource",
              className: "fa fa-database icon-database",
              command: function command(editor, sender) {
                sender.set("active", 0);
                editor.runCommand('datasource-modal');
              },
              attributes: {
                title: "Datasource"
              }
            }]);
            // const inputTypes = [
            //   {value: 'text', name: 'Text'},
            //   {value: 'email', name: 'Email'},
            //   {value: 'password', name: 'Password'},
            //   {value: 'number', name: 'Number'},
            // ];

            // bm.add('testBlock', {
            //   label: 'For Block',
            //   type: 'new-component',
            //   content: {
            //     type: 'new-component', // Built-in 'map' component
            //     style: {
            //       height: '350px'
            //     },
            //     removable: false, // Once inserted it can't be removed
            //   }
            // });

            editor.TraitManager.addType('for', {
              events:{
                'keyup': 'onChange',  // trigger parent onChange method on keyup
              },
              /**
              * Returns the input element
              * @return {HTMLElement}
              */
              getInputEl: function() {
                if (!this.inputEl) {
                  var input = document.createElement('input');

                  input.value = this.target.get('for')||'';
                  this.inputEl = input;
                }
                if(this && this.inputEl.value === ''){
                  const el = this.target.getEl();
                  const parent = el.parentNode;
                  if(Comment.prototype.isPrototypeOf(el.previousSibling) && Comment.prototype.isPrototypeOf(el.nextSibling)){
                    this.inputEl.value = el.previousSibling.textContent.replace(' for(', '').replace('){ ', '');
                  }
                }
                return this.inputEl;
              },

              /**
               * Triggered when the value of the model is changed
               */
              onValueChange: function () {
                const el = this.target.getEl();
                const parent = el.parentNode;
                if(Comment.prototype.isPrototypeOf(el.previousSibling) && Comment.prototype.isPrototypeOf(el.nextSibling)){
                  $(el.nextSibling).remove();
                  $(el.previousSibling).remove();
                }
                if(this.model !== undefined && !!this.model.get('value')){
                  $(el).before(document.createComment(' for('+ this.model.get('value') +'){ '));
                  $(el).after(document.createComment(' }endfor '));
                }
                this.target.set('for', this.model.get('value'));
              }
            });

            // dc.addType('new-component', {
            //   model: defaultModel.extend({
            //     // Extend default properties
            //     defaults: Object.assign({}, defaultModel.prototype.defaults, {
            //       // Can be dropped only inside `form` elements
            //       // draggable: 'form, form *',
            //       // Can't drop other elements inside it
            //       // droppable: false,
            //       // Traits (Settings)
            //       traits: ['name', 'placeholder', {
            //           // Change the type of the input (text, password, email, etc.)
            //           type: 'select',
            //           label: 'Type',
            //           name: 'type',
            //           options: inputTypes,
            //         },{
            //           // Can make it required for the form
            //           type: 'checkbox',
            //           label: 'Required',
            //           name: 'required',
            //       },{
            //           // Can make it required for the form
            //           type: 'for',
            //           label: 'For',
            //           name: 'forIn',
            //       }],
            //     }),
            //   },
            //   // The second argument of .extend are static methods and we'll put inside our
            //   // isComponent() method. As you're putting a new Component type on top of the stack,
            //   // not declaring isComponent() might probably break stuff, especially if you extend
            //   // the default one.
            //   {
            //     isComponent: function(el) {
            //       return false
            //     },
            //   }),
            //   view: defaultType.view.extend({
            //     // Bind events
            //     events: {
            //       // If you want to bind the event to children elements
            //       // 'click .someChildrenClass': 'methodName',
            //       click: 'handleClick',
            //       dblclick: function(){
            //         alert('Hi!');
            //       }
            //     },

            //     init() {
            //       console.log('Local hook: view.init');
            //     },
            //     onRender() {
            //       console.log('Local hook: view.onRender');
            //     },

            //     // It doesn't make too much sense this method inside the component
            //     // but it's ok as an example
            //     randomHex: function() {
            //       return '#' + Math.floor(Math.random()*16777216).toString(16);
            //     },

            //     handleClick: function(e) {
            //       this.model.set('style', {color: this.randomHex()}); // <- Affects the final HTML code
            //       this.el.style.backgroundColor = this.randomHex(); // <- Doesn't affect the final HTML code
            //       // Tip: updating the model will reflect the changes to the view, so, in this case,
            //       // if you put the model change after the DOM one this will override the backgroundColor
            //       // change made before
            //     },
            //     // The render() should return 'this'
            //     render: function () {
            //       // Extend the original render method
            //       defaultType.view.prototype.render.apply(this, arguments);
            //       this.el.placeholder = 'Text here'; // <- Doesn't affect the final HTML code
            //       return this;
            //     },
            //   }),
            // });
            const newTrait = {
                type: 'for',
                label: 'For',
                name: 'for',
            };
            ['default','wrapper','text','textnode','svg','script','image','video','label','link','map','table','row','cell'].forEach(component => {
              var originalComponent = dc.getType(component);
              if(!originalComponent.model.prototype.defaults.traits.includes(newTrait)){
                originalComponent.model.prototype.defaults.traits.push(newTrait);
                if(originalComponent.model.prototype.toHTML){
                  const toHTMLSuper = originalComponent.model.prototype.toHTML;
                  originalComponent.model.prototype.toHTML = function(){
                    const html = toHTMLSuper.bind(this)(arguments);
                    if(this.get('for')){
                      const el = this.getEl();
                      return $('<div>').append(el.previousSibling.cloneNode(true), el.cloneNode(true), el.nextSibling.cloneNode(true)).html();
                    }
                    return html;
                  }
                }
              }
              
              const modelComp = originalComponent.model.extend({
                defaults:Object.assign({}, originalComponent.model.prototype.defaults, {
                    traits: originalComponent.model.prototype.defaults.traits,
                    toHTML(){
                      return ''
                    }
                  })
              }, {});
              dc.addType(component, {
                model: modelComp,
                view: originalComponent.view
              });
            });
          }catch(err){
            console.error(err);
          }
      }
      
      var editor = grapesjs.init({
        showOffsets: 1,
        noticeOnUnload: 0,
        container: '#gjs',
        height: '100%',
        fromElement: true,
        storageManager: { autoload: 0 },
        styleManager : {
          sectors: [{
              name: 'General',
              open: false,
              buildProps: ['float', 'display', 'position', 'top', 'right', 'left', 'bottom']
            },{
              name: 'Flex',
              open: false,
              buildProps: ['flex-direction', 'flex-wrap', 'justify-content', 'align-items', 'align-content', 'order', 'flex-basis', 'flex-grow', 'flex-shrink', 'align-self']
            },{
              name: 'Dimension',
              open: false,
              buildProps: ['width', 'height', 'max-width', 'min-height', 'margin', 'padding'],
            },{
              name: 'Typography',
              open: false,
              buildProps: ['font-family', 'font-size', 'font-weight', 'letter-spacing', 'color', 'line-height', 'text-shadow'],
            },{
              name: 'Decorations',
              open: false,
              buildProps: ['border-radius-c', 'background-color', 'border-radius', 'border', 'box-shadow', 'background'],
            },{
              name: 'Extra',
              open: false,
              buildProps: ['transition', 'perspective', 'transform'],
            },
            {
              name: 'Datasource',
              open: false,
              buildProps: ['datasource', 'meta'],
            }
          ],
        },
        plugins: ['gjs-preset-webpage','grapesjs-custom-code', 'grapesjs-plugin-export', myPlugin],
        pluginsOpts: {
          'gjs-preset-webpage': {
            // options
          },
          myPlugin:{
            optionalValues:true
          }
        }
      });
      
    </script>
  </body>
</html>
